# Final Build & Distribution Guide

## Overview
This guide covers the complete process for building and distributing the Sakr Store Manager application on Windows.

---

## Prerequisites

### Required Software
- **Node.js** (v16 or higher)
- **npm** (comes with Node.js)
- **Git** (for version control)

### Required npm Packages
All dependencies are listed in `package.json`. Install them with:
```bash
npm install
```

---

## Build Configuration

### package.json Build Settings

The `build` section in `package.json` is configured as follows:

```json
{
  "build": {
    "appId": "com.sakrstore.manager",
    "productName": "Sakr Store Manager",
    "files": [
      "dist/**/*",
      "electron/**/*",
      "package.json",
      "!node_modules/**/*",
      "node_modules/sharp/**/*"
    ],
    "asarUnpack": [
      "node_modules/sharp/**/*"
    ],
    "directories": {
      "output": "release",
      "buildResources": "build"
    },
    "win": {
      "target": ["nsis", "portable"],
      "icon": "build/icon.ico"
    }
  }
}
```

#### Key Configuration Explained:

- **`appId`**: `com.sakrstore.manager` - Unique identifier for the app
- **`productName`**: "Sakr Store Manager" - Display name of the application
- **`files`**: Specifies which files to include in the build
  - `dist/**/*` - The built React app
  - `electron/**/*` - Electron main process files
  - `node_modules/sharp/**/*` - Sharp library for image processing (must be unpacked)
- **`asarUnpack`**: Files that must not be packed into asar archive (Sharp native modules)
- **`directories.output`**: "release" - Output folder for build artifacts
- **`directories.buildResources`**: "build" - Folder containing icons and resources
- **`win.target`**: 
  - `nsis` - Creates a Windows installer (.exe)
  - `portable` - Creates a portable executable (no installation needed)
- **`win.icon`**: "build/icon.ico" - Windows application icon

---

## Icon Files

### Required Icons

Before building, you must create application icons:

1. **Windows**: `build/icon.ico` (256x256, 128x128, 64x64, 48x48, 32x32, 16x16)
2. **macOS**: `build/icon.icns` (for future macOS builds)
3. **Linux**: `build/icon.png` (512x512)

### Creating Icons

#### Quick Method (Recommended):
```bash
# Run the provided script
create-icons.bat
```

This script:
1. Installs `electron-icon-maker` globally (if not installed)
2. Generates all icon files from `build/icon.svg`
3. Places them in the `build/` directory

#### Manual Method:
See `build/ICON_INSTRUCTIONS.md` for detailed instructions on creating icons manually.

---

## Auto-Updater Configuration

### How It Works

The app uses `electron-updater` to check for updates automatically:

1. **On Startup**: App checks GitHub Releases for new versions
2. **Update Available**: User is prompted to download
3. **Download Complete**: User can install now or later
4. **Auto-Install**: Update installs when the app quits

### Configuration

In `package.json`, the publish configuration specifies where to check for updates:

```json
{
  "build": {
    "publish": {
      "provider": "github",
      "owner": "your-github-username",
      "repo": "sakr-store-manager"
    }
  }
}
```

**IMPORTANT**: Update `owner` and `repo` with your actual GitHub username and repository name.

### Publishing Updates

To release an update:

1. Update version in `package.json`:
   ```json
   {
     "version": "1.0.1"
   }
   ```

2. Build the app:
   ```bash
   npm run electron:build
   ```

3. Create a GitHub Release:
   - Go to your GitHub repository
   - Click "Releases" â†’ "Create a new release"
   - Tag version: `v1.0.1`
   - Upload files from `release/` folder:
     - `Sakr Store Manager Setup 1.0.1.exe`
     - `latest.yml` (auto-generated by electron-builder)

4. Publish the release

Users with v1.0.0 will be automatically notified of the update.

---

## Build Process

### Step 1: Prepare for Build

1. **Ensure all dependencies are installed**:
   ```bash
   npm install
   ```

2. **Create icon files** (if not already created):
   ```bash
   create-icons.bat
   ```

3. **Update version** in `package.json` if needed:
   ```json
   {
     "version": "1.0.0"
   }
   ```

4. **Update GitHub publish config** in `package.json`:
   ```json
   {
     "build": {
       "publish": {
         "provider": "github",
         "owner": "YOUR_GITHUB_USERNAME",
         "repo": "sakr-store-manager"
       }
     }
   }
   ```

### Step 2: Build the Application

Run the build command:

```bash
npm run electron:build
```

This command does the following:

1. **`vite build`**: 
   - Compiles and optimizes the React application
   - Outputs to `dist/` folder
   - Minifies JavaScript and CSS
   - Optimizes assets

2. **`electron-builder`**:
   - Packages Electron with the built React app
   - Includes Node.js runtime
   - Packages native modules (Sharp)
   - Creates installers and portable executables
   - Generates auto-update metadata files

### Step 3: Build Outputs

After building, check the `release/` folder:

```
release/
â”œâ”€â”€ Sakr Store Manager Setup 1.0.0.exe    (NSIS Installer - ~150-200 MB)
â”œâ”€â”€ Sakr Store Manager 1.0.0 Portable.exe (Portable - ~150-200 MB)
â”œâ”€â”€ latest.yml                             (Auto-update metadata)
â””â”€â”€ builder-debug.yml                      (Build debug info)
```

---

## Testing the Build

### Test 1: NSIS Installer

#### On Your Development Machine:

1. **Locate the installer**:
   ```
   release/Sakr Store Manager Setup 1.0.0.exe
   ```

2. **Run the installer**:
   - Double-click the `.exe` file
   - Choose installation directory (default: `C:\Users\{username}\AppData\Local\Programs\sakr-store-manager`)
   - Select desktop shortcut option
   - Click Install

3. **Verify installation**:
   - Check Start Menu for "Sakr Store Manager"
   - Check Desktop for shortcut (if selected)
   - Launch the app from Start Menu
   - Verify the app opens and functions correctly

4. **Test app functionality**:
   - Load/create a project
   - Add a product
   - Upload images
   - Save and verify data persists
   - Test GitHub integration (if configured)

5. **Test uninstallation**:
   - Go to Settings â†’ Apps â†’ Sakr Store Manager
   - Click Uninstall
   - Verify app is removed
   - Check that shortcuts are removed
   - Check that installation directory is deleted

#### On a Clean Windows Machine (Recommended):

1. **Setup a test environment**:
   - Use a Windows VM (VirtualBox, VMware, or Hyper-V)
   - Or use a clean physical Windows machine
   - Ensure no development tools are installed

2. **Copy the installer**:
   - Transfer `Sakr Store Manager Setup 1.0.0.exe` to the test machine

3. **Install and test**:
   - Run the installer
   - Launch the app
   - Test all core features
   - Verify the app works without development dependencies

4. **Check for issues**:
   - Missing DLLs or runtime errors
   - Image processing functionality (Sharp library)
   - File system operations
   - Git integration

### Test 2: Portable Version

1. **Locate the portable executable**:
   ```
   release/Sakr Store Manager 1.0.0 Portable.exe
   ```

2. **Test without installation**:
   - Copy the `.exe` to any folder
   - Double-click to run
   - The app should launch immediately without installation

3. **Verify portability**:
   - Copy to a USB drive
   - Run from the USB drive
   - Verify all features work
   - No installation or admin rights required

4. **Test data persistence**:
   - Create a project
   - Add products
   - Close and reopen the app
   - Verify data is saved

### Test 3: Auto-Updater (Optional)

To test auto-updates:

1. **Install version 1.0.0**

2. **Create a new version 1.0.1**:
   - Update `package.json` version to "1.0.1"
   - Make a small change (e.g., update a label)
   - Run `npm run electron:build`

3. **Publish to GitHub**:
   - Create a new release on GitHub: v1.0.1
   - Upload `Sakr Store Manager Setup 1.0.1.exe`
   - Upload `latest.yml`

4. **Test update**:
   - Launch the installed v1.0.0 app
   - It should check for updates on startup
   - You should see a dialog about the new version
   - Click "Download" to test the update process
   - Verify the app updates to v1.0.1

---

## Common Build Issues and Solutions

### Issue 1: "Icon file not found"

**Error**: `Cannot find icon file: build/icon.ico`

**Solution**:
```bash
# Run the icon creation script
create-icons.bat

# Or manually create icons (see build/ICON_INSTRUCTIONS.md)
```

### Issue 2: "Sharp module not found"

**Error**: `Error: Cannot find module 'sharp'`

**Solution**:
- Ensure Sharp is in dependencies (not devDependencies)
- Rebuild Sharp for Electron:
  ```bash
  npm rebuild sharp --platform=win32 --arch=x64
  ```

### Issue 3: "Build fails with ENOENT error"

**Error**: Various file not found errors

**Solution**:
```bash
# Clean and rebuild
rm -rf dist release node_modules
npm install
npm run electron:build
```

### Issue 4: Large installer size

**Issue**: Installer is > 200 MB

**Explanation**: This is normal because the installer includes:
- Electron runtime (~100 MB)
- Node.js runtime (~30 MB)
- Sharp native modules (~20 MB)
- Your application code and assets

**To reduce size**:
- Enable compression in electron-builder (already enabled)
- Remove unused dependencies
- Optimize images and assets

### Issue 5: Auto-updater not working

**Issue**: App doesn't check for updates

**Checklist**:
1. Ensure `publish` config is correct in `package.json`
2. Verify GitHub release is published (not draft)
3. Check that `latest.yml` is uploaded to GitHub release
4. App only checks for updates in production builds (not dev mode)
5. Check console for auto-updater errors

---

## Distribution Checklist

Before distributing your app:

- [ ] **Version updated** in `package.json`
- [ ] **Icons created** (build/icon.ico exists)
- [ ] **GitHub publish config** updated with correct username/repo
- [ ] **Build successful** (`npm run electron:build` completes without errors)
- [ ] **Installer tested** on clean Windows machine
- [ ] **Portable version tested**
- [ ] **All features working** (products, images, Git integration)
- [ ] **Uninstaller tested**
- [ ] **Release notes prepared**
- [ ] **GitHub release created** (if using auto-updates)

---

## Deployment Methods

### Method 1: Direct Distribution

1. Upload installers to your website:
   - `Sakr Store Manager Setup 1.0.0.exe`
   - `Sakr Store Manager 1.0.0 Portable.exe`

2. Provide download links to users

3. Users download and install

**Pros**: Simple, full control
**Cons**: No auto-updates (unless you setup a custom update server)

### Method 2: GitHub Releases

1. Create a GitHub release:
   - Tag: `v1.0.0`
   - Title: "Sakr Store Manager v1.0.0"
   - Description: Release notes

2. Upload files:
   - `Sakr Store Manager Setup 1.0.0.exe`
   - `Sakr Store Manager 1.0.0 Portable.exe`
   - `latest.yml` (for auto-updates)

3. Publish the release

**Pros**: Auto-updates work, version tracking
**Cons**: Requires GitHub account and public/private repo

### Method 3: Microsoft Store (Advanced)

For wider distribution, consider publishing to the Microsoft Store:
- Requires a Microsoft developer account ($19 one-time fee)
- More complex process
- Reach more users
- Automatic updates through Windows

---

## Version Management

### Semantic Versioning

Follow semantic versioning (semver):

- **Major version** (1.x.x): Breaking changes
- **Minor version** (x.1.x): New features, backwards compatible
- **Patch version** (x.x.1): Bug fixes

Examples:
- `1.0.0` - Initial release
- `1.0.1` - Bug fix
- `1.1.0` - New feature added
- `2.0.0` - Major rewrite or breaking changes

### Updating the Version

1. Edit `package.json`:
   ```json
   {
     "version": "1.0.1"
   }
   ```

2. Create a changelog entry

3. Commit the version change:
   ```bash
   git add package.json
   git commit -m "Bump version to 1.0.1"
   git tag v1.0.1
   git push origin main --tags
   ```

4. Build and release

---

## Support and Troubleshooting

### Logs Location

- **Windows**: `%APPDATA%\sakr-store-manager\logs\`
- **Development**: Check console in DevTools (F12)

### Debug Mode

To enable detailed logging:

1. Set environment variable:
   ```bash
   $env:DEBUG="electron-updater"
   npm run electron:dev
   ```

2. Check console for detailed auto-updater logs

### Getting Help

If you encounter issues:

1. Check this documentation
2. Review build errors carefully
3. Check electron-builder documentation: https://www.electron.build/
4. Check electron-updater documentation: https://www.electron.build/auto-update

---

## Next Steps

After successful build and distribution:

1. **Monitor user feedback**
2. **Track issues** (use GitHub Issues)
3. **Plan updates** (bug fixes, new features)
4. **Maintain changelog**
5. **Regular releases** (monthly or as needed)

---

## Quick Reference

### Build Commands
```bash
# Development
npm run electron:dev

# Production build
npm run electron:build

# Create icons
create-icons.bat

# Install dependencies
npm install

# Run tests
npm test
```

### File Structure
```
sakr-store-manager/
â”œâ”€â”€ build/                  # Icon files
â”‚   â”œâ”€â”€ icon.ico
â”‚   â”œâ”€â”€ icon.icns
â”‚   â””â”€â”€ icon.png
â”œâ”€â”€ dist/                   # Built React app (generated)
â”œâ”€â”€ electron/               # Electron main process
â”‚   â”œâ”€â”€ main.js
â”‚   â””â”€â”€ preload.js
â”œâ”€â”€ release/                # Build output (generated)
â”‚   â”œâ”€â”€ Sakr Store Manager Setup 1.0.0.exe
â”‚   â””â”€â”€ Sakr Store Manager 1.0.0 Portable.exe
â”œâ”€â”€ src/                    # React source code
â”œâ”€â”€ package.json            # Dependencies and build config
â””â”€â”€ vite.config.js         # Vite configuration
```

---

## Appendix: Advanced Configuration

### Custom NSIS Installer Options

To customize the installer, add to `package.json`:

```json
{
  "build": {
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true,
      "shortcutName": "Sakr Store Manager",
      "installerIcon": "build/icon.ico",
      "uninstallerIcon": "build/icon.ico",
      "installerHeaderIcon": "build/icon.ico",
      "license": "LICENSE.txt"
    }
  }
}
```

### Code Signing (Recommended for Production)

To avoid Windows SmartScreen warnings:

1. Purchase a code signing certificate
2. Add to `package.json`:
   ```json
   {
     "build": {
       "win": {
         "certificateFile": "path/to/certificate.pfx",
         "certificatePassword": "your-password"
       }
     }
   }
   ```

**Note**: Code signing certificates cost ~$100-500/year but significantly improve user trust.

---

## Conclusion

You now have a complete build system for the Sakr Store Manager application. Follow this guide to create production-ready installers for Windows with auto-update support.

For questions or issues, refer to the troubleshooting section or consult the official Electron and electron-builder documentation.

**Happy building! ðŸš€**
